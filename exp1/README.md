# Execution of the first experiment

This experiment shows an example on how to use DVC along with Git. Airflow executes each DVC command automatically

To execute the experiment some requirements must be satisfied:
- **Software - DVC**: In this experiment, DVC is used as a command not as Python package, so it cannot be installed with pip or Conda. It can be installed with snap, from the repository or from the binary package. Visit [this link](https://dvc.org/doc/install/linux) for more information.
- **Packages and dependencies** to install them automatically, run:
    - `conda env create -f my_env.yaml`
    - `conda activate exp1`
- **Airflow first time set up**: the first time running Airflow in a device, the following commands must be run:
    - `airflow db init`
    - `airflow users create --username admin --password admin --role Admin --firstname admin --lastname adminLast --email admin.airflow@gmail.com`
- **Airflow launch**: Then run airflow with the following commands in the conda env created above (called exp1):
    - `airflow webserver`
    - `airflow scheduler`
- **DAG running**: some requeriments must be satisfaced:
    - **An SSH key is needed and must be registered in git**:
        - Create SSH key (for a complete tutorial see [this link](https://linuxkamarada.com/en/2019/07/14/using-git-with-ssh-keys/#.YbI7zLuCG00)). To do so, run: 
            - `ssh-keygen -t rsa -b 4096 -C "your_email@domain.com"` and press enter
            - When prompted, choose your passphrase and press enter
            - Copy the key, it is located after the following sentence: __The key fingerprint is:__
            - If everything has executed correctly the following command `ls ~/.ssh/id_*` must prompt any of id_dsa.pub, id_ecdsa.pub, id_ed25519.pub, or id_rsa.pub.
            - To check if your SSH key is active run the following command: `ssh-add -l`. If SSH fingerprint is prompted along with your email, then it is active. If it is not active run the following command: `ssh-add` then type the passphrase you chose before. 
        - [Register the newly created SSH key in GitHub](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account):
            - Access to your GitHub account -> Settings -> SSH and GPG keys -> New SSH Key"
            - Choose a title for your key
            - In the "Key" field, paste the key you generated before
    - This experiment assumes that **the commands `git init`, `dvc init` and `git remote add <name_repo_ssh> <clone link shh>` have been executed in the local repository**
    - Move the dag creation file (`src/dag_exp1.py`) file to ~/airflow/dags
    - **Three Airflow variables must be set**:
        - Airflow variables can be set via two methods:
            - Running the command: `airflow variables set <key> <value>`
            - Airflow UI: being logged in as a user with the admin role, in tab Admin->Variables
        - __path_to_repo_exp1__ variable indicates the **absolute path** where at least src folder, params.yaml and my_env.yaml files are located. This path must be inside the DVC and Git repositories. **DAG execution assumes Git and DVC repos are located in parent folder of this path.**
        - __name_repo_ssh__ variable indicates the name given to the SSH remote in the command `git remote add`. 
        - __email_to_notify_exp1__ variable sets the receiver email to notify success or failure of the tasks executed in Airflow. It can be set to a dummy value (but this value should have the format of an email address) and the feature will not be used. If you want to use this feature, apart from setting this variable to a valid email, an [SMTP server must be configured](https://stackoverflow.com/questions/51829200/how-to-set-up-airflow-send-email) in airflow.cfg. If you want to use your Gmail account, a key generated by Google is needed.

